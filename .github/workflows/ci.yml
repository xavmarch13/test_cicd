name: Test on LocalStack

on:
  push:
    branches: [ main, dev, ltiq ]  # Trigger on pushes to these branches
  pull_request:
    branches: [ main, dev, ltiq ]  # Trigger on PRs targeting these branches
  workflow_dispatch:               # Allow manual runs from the Actions tab

jobs:
  terraform:
    name: Deploy on LocalStack
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Start LocalStack with Pro features enabled
      - name: Start LocalStack
        uses: LocalStack/setup-localstack@v0.2.2
        with:
          image-tag: 'latest'
          install-awslocal: 'true'
          configuration: DEBUG=1

      # Step 3: Debug Environment Variables
      - name: Debug Environment Variables
        run: |
          echo "AWS_ACCESS_KEY_ID: $AWS_ACCESS_KEY_ID"
          echo "AWS_SECRET_ACCESS_KEY: $AWS_SECRET_ACCESS_KEY"
          echo "AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"
          echo "TF_VAR_REGION: $TF_VAR_REGION"
          echo "TF_VAR_STATE_BUCKET_NAME: $TF_VAR_STATE_BUCKET_NAME"
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACESS_KEY }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          TF_VAR_REGION: ${{ vars.TF_VAR_REGION }}
          TF_VAR_STATE_BUCKET_NAME: ${{ vars.TF_VAR_STATE_BUCKET_NAME }}

      # Step 4: Terraform Init with Inline Backend Config
      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ vars.TF_VAR_STATE_BUCKET_NAME }}" \
            -backend-config="key=${{ github.ref_name }}/terraform.tfstate" \
            -backend-config="region=${{ vars.AWS_DEFAULT_REGION }}" \
            -backend-config="access_key=${{ vars.AWS_ACCESS_KEY_ID }}" \
            -backend-config="secret_key=${{ secrets.AWS_SECRET_ACESS_KEY }}" \
            -backend-config="endpoint=http://localhost:4566" \
            -backend-config="skip_credentials_validation=true" \
            -backend-config="skip_metadata_api_check=true" \
            -backend-config="force_path_style=true"
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACESS_KEY }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          TF_VAR_REGION: ${{ vars.TF_VAR_REGION }}
          TF_VAR_STATE_BUCKET_NAME: ${{ vars.TF_VAR_STATE_BUCKET_NAME }}

      # Step 5: Terraform Plan
      - name: Terraform Plan
        run: terraform plan -out=tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACESS_KEY }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          TF_VAR_REGION: ${{ vars.TF_VAR_REGION }}
          TF_VAR_STATE_BUCKET_NAME: ${{ vars.TF_VAR_STATE_BUCKET_NAME }}

      # Step 6: Terraform Apply
      - name: Terraform Apply
        if: github.event_name == 'push' && contains(github.event.head_commit.message, 'tf-apply')
        run: terraform apply -auto-approve tfplan
        env:
          AWS_ACCESS_KEY_ID: ${{ vars.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACESS_KEY }}
          AWS_DEFAULT_REGION: ${{ vars.AWS_DEFAULT_REGION }}
          TF_VAR_REGION: ${{ vars.TF_VAR_REGION }}
          TF_VAR_STATE_BUCKET_NAME: ${{ vars.TF_VAR_STATE_BUCKET_NAME }}


